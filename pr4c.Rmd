---
title: 'Projekt: Analiza spektralna'
author: "Magdalena Smalarz"
output:
  html_document: default
  word_document: default
---
<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#rm(list=ls()) 
#Używane biblioteki
library(outliers)
library(oce)
library(lomb)
library(multitaper)
library(knitr)
#Wczytanie danych
dane<-read.table("dane.csv",header=FALSE,sep="")
dane2<-ts(read.table("dane.csv"),start=2010,frequency=12)
```

## 1. Wstęp
Stopa bezrobocia to wielkość statystyczna opisująca nasilenie zjawiska bezrobocia w danej populacji. Najczęściej definiuje się ją jako stosunek liczby osób bezrobotnych do liczby ludności aktywnej zawodowo (zasobu siły roboczej danej populacji). Tak zdefiniowaną stopę bezrobocia oblicza się różnie, w zależności od przyjętej definicji osoby bezrobotnej.

Najczęściej praktykowane, ale nie do końca prawidłowe, jest podawanie stopy bezrobocia rejestrowanego, do wyliczenia której przyjmuje się, że bezrobotny, to osoba, która jest aktualnie zarejestrowana zgodnie z prawem danego kraju, jako poszukująca pracy. Natomiast Międzynarodowa Organizacja Pracy zaleca wyliczanie stopy bezrobocia zgodnie z następującą definicją: za bezrobotną uważa się osobę, która spełnia równocześnie wszystkie poniższe warunki:

* ukończyła 15 lat;
* aktualnie nie pracuje (nie świadczy pracy w rozumieniu definicji MOP), ani nie odbywa przyuczenia do zawodu z elementami nauki praktycznej;
* poszukiwała aktywnie pracy w tygodniu badania lub w ciągu 6 tygodni poprzedzających badanie;
* jest zdolna do podjęcia pracy w tygodniu badanym lub następnym i wyraża gotowość podjęcia takiej pracy.

W Polsce podaje się najczęściej stopę bezrobocia rejestrowanego, natomiast GUS bada także stopę bezrobocia według definicji MOP (w ramach BAEL – Badania Aktywności Ekonomicznej Ludności, co kwartał na próbie rotacyjnej 20 000 gospodarstw domowych). Stopa bezrobocia rejestrowanego wypada przeciętnie ok. 1,5% poniżej stopy bezrobocia ustalonej w badaniu GUS.

W projekcie postaram się dowiedzieć czy biorąc pod uwagę wielkość stopy bezrobocia rejestrowanego można mówić o dominujących cyklach mających wpływ na jej zmienność. Przyjęty poziom istotności w projekcie: $\alpha$ = 0,05.

## 2. Dane
Dane pochodzą z Banku Danych Makroekonomicznych i dotyczą stopy bezrobocia rejestrowanego w Polsce (stan w końcu okresu) wyrażonego w procentach [%] w ujęciu miesięcznym. W projekcie uwzględniono dane z okresu: styczeń 2010 - grudzień 2020.
Stopę bezrobocia obliczono przy wykorzystaniu danych m.in. dot. pracujących w rolnictwie indywidualnym (będących składową cywilnej ludności aktywnej zawodowo) wyszacowanych na podstawie wyników Spisów:

* do 1995 r. - Narodowego Spisu Powszechnego 1988,
* od 1996 r. do 2002 r. (w wariancie "a") - Powszechnego Spisu Rolnego 1996,
* od 2002 r. (w wariancie "b") - Narodowego Spisu Powszechnego Ludności i Mieszkań oraz Powszechnego Spisu Rolnego 2002,
* od grudnia 2010 r. - Powszechnego Spisu Rolnego 2010.

Poniżej przedstawiono kilka losowo wybranych danych oraz wykres danych.
```{r, echo=FALSE}
randomRows = function(df,n){
   return(df[sample(nrow(df),n),])
}
randomRows(dane2,10)
```

```{r, echo=FALSE, fig.align = 'center'}
plot(dane2, type="l", ylab="Unemployment rate",xlab="Year",col=grey(.05))
```

## 3. Dekompozycja szeregu czasowego

### 3.1. Metoda LOESS
Dekompozycja szeregu czasowego przy użyciu metody LOESS (STL) to algorytm, który został opracowany, w celu podzielenia szeregu czasowego na trzy komponenty: trend, sezonowość i resztę. STL jest dostępny w R za pośrednictwem funkcji *stl()*. 
```{r, echo=FALSE, fig.align = 'center'}
dane_loess<-ts(dane[1:132,1],frequency=12)
dane_loess = stl(dane_loess, s.window="periodic")
plot(dane_loess) #składowe szeregu czasowego
```

### 3.2. Średnie ruchome
Do wyznaczenia elementów, z jakich składa się badany szereg czasowy wykorzystano także średnie ruchome oraz dostępną w pakiecie RStudio funkcję *decompose()*.

```{r, echo=FALSE, fig.align = 'center'}
dane_srednie<-decompose(dane2)
plot(dane_srednie) #składowe szeregu czasowego
```

### 3.3. Usunięcie trendu z danych
Aby uniknąć występowania wolnych częstotliwości zaburzających interpretacje otrzymanego wyniku analizy spektralnej, usunięto trend z danych. Wykorzystano funkcję *diff()* pakietu RStudio.

```{r, echo=FALSE, fig.align = 'center'}
dane_beztrendu<-diff(ts(log(dane2)))
plot(dane_beztrendu) #wykres danych bez trendu
```

### 3.4. Określenie rzędu okresowości
Wykorzystując usunięcie trendu z danych i wcześniej wspomiane średnie ruchome, określono rząd okresowości badanych danych. Poniżej zostały zestawione wykresy wygładzone średnimi ruchomymi rządu: 2,3,4,5,10,12 i 20.

```{r, echo=FALSE, fig.align = 'center'}
#wygladzenie srednia ruchoma rzedu 2
plot(dane_beztrendu)
f2<-c(1/4,1/2,1/4)
sr2 <-filter(dane_beztrendu,f2,sides=2)
lines(sr2, col="orange")
#wygladzenie srednia ruchoma rzedu 3
f3<-c(1/3,1/3,1/3)
sr3<-filter(dane_beztrendu,f3,sides=2)
lines(sr3, col="blue")
#wygladzenie srednia ruchoma rzedu 4
f4<-c(1/8,1/4,1/4,1/4,1/8)
sr4 <-filter(dane_beztrendu,f4,sides=2)
lines(sr4, col="red")
#wygladzenie srednia ruchoma rzedu 5
f5<-c(1/5,1/5,1/5,1/5,1/5)
sr5 <-filter(dane_beztrendu,f5,sides=2)
lines(sr5, col="green")
#wygladzanie srednia ruchoma rzedu 10
f10<-rep(1/10,10)
sr10<-filter(dane_beztrendu,f10,sides=2)
lines(sr10,col="yellow")
#wygladzanie srednia ruchoma rzedu 12
f12<-rep(1/12,12)
sr12<-filter(dane_beztrendu,f12,sides=2)
lines(sr12,col="magenta")
#wygladzanie srednia ruchoma rzedu 20
f20<-rep(1/20,20)
sr20 <- filter(dane_beztrendu,f20,sides=2)
lines(sr20, col="grey")
```

Legenda: linia pomarańczowa - rząd 2; linia niebieska - rząd 3; linia czerwona - rząd 4; linia zielona - rząd 5; linia żółta - rząd 10; linia różowa - rząd 12; linia szara - rząd 20.

Długość okresu (rząd okresowości) występujący w danych jest równy 12, ponieważ widać, że większy ani mniejszy rząd średniej ruchomej nie poprawia wygładzenia wykresu, wręcz powoduje kolejne wahania. Poniżej został zaprezentowany wygładzony sygnał średnią ruchomą rzędu 12.

```{r, echo=FALSE, fig.align = 'center'}
dane3<-sr12
plot(dane3,type="l",col="magenta")
```

## 4. Periodogramy
W celu określenia długości cykli mających dominujący wpływ na zmienność stopy bezrobocia rejestrowanego w Polsce na przestrzeni lat 2010-2020 wyznaczono różne rodzaje periodogramów. Do ich wykreślenia użyto danych pozbawionych trendu.

### 4.1. Periodogram naiwny
```{r, echo=FALSE, fig.align = 'center'}
P1<-spec.pgram(dane_beztrendu,log='no',taper=0,pad=0,fast=FALSE,detrend=FALSE)
abline(v=0.083969466,lty='dotted',col="magenta") #przybliżone v
abline(v=0.167938931,lty='dotted',col="red")
abline(v=0.251908397,lty='dotted',col="orange")
abline(v=0.335877863,lty='dotted',col="yellow")
```

Legenda: linia różowa - częstotliwość 1/12; linia czerwona - częstotliwość 1/6; linia pomarańczonwa - częstotliwość 1/4; linia żółta - częstotliwość 1/3.

Na periodogramie widać jeden dominujący pik przy częstotliwości 1/12. Analizowane dane są w ujęciu miesięcznym co oznacza, że w danych występuje cykl roczny. Oprócz tego, pojawiają się mniejsze piki przy częstotliwościach bliskich 1/6, 1/4 i 1/3, co wskazuje na występowanie cykli półrocznych, czteromiesięcznych i kwartalnych.

### 4.2. Periodogram wygładzony oknem Daniella
```{r, echo=FALSE, fig.align = 'center'}
par(mfrow=c(3,2))
window_1<-kernel('daniell',3)
window_2<-kernel('daniell',5)
window_3<-kernel('daniell',c(2,2))
plot(window_1)
spec.pgram(dane_beztrendu,kernel=window_1,log='no',taper=0,fast=FALSE,detrend=FALSE)
abline(v=1/12,lty='dotted',col="magenta")
abline(v=1/6,lty='dotted',col="red")
plot(window_2)
spec.pgram(dane_beztrendu,kernel=window_2,log='no',taper=0,fast=FALSE,detrend=FALSE)
abline(v=1/12,lty='dotted',col="magenta")
abline(v=1/6,lty='dotted',col="red")
plot(window_3)
P2<-spec.pgram(dane_beztrendu,kernel=window_3,log='no',taper=0,fast=FALSE,detrend=FALSE)
abline(v=1/12,lty='dotted',col="magenta")
abline(v=1/6,lty='dotted',col="red")
```

Legenda: linia różowa - częstotliwość 1/12; linia czerwona - częstotliwość 1/6.

Po wygładzeniu periodogramu oknem Daniella m=c(2,2) można dostrzec dwa piki przy częstotliwościach 1/12 i 1/6. Przy oknach o m=3 i m=5 występuje sytuacja trudna do interpretacji, ponieważ periodogram stał się bardziej płaski i każda z częstotliwości w takim przypadku byłaby równie istotna. 


### 4.3. Periodogram multitaper
Wykresy przedstawiają kolejno: periodogram wykonany metodą multitaper, ten sam periodogram lecz z przedziałami ufności na przyjętym poziomie istotności oraz wykres statystki F.

```{r, echo=FALSE, warning=FALSE, fig.align = 'center'}
par(mfrow=c(2,2))
#Multitaper - linie istotności dla statystyki F 
P4 <- spec.mtm(dane_beztrendu, Ftest = TRUE) 
abline(v=1/12,lty='dotted',col="magenta")
abline(v=1/6,lty='dotted',col="red")
abline(v=1/4,lty='dotted',col="orange")
abline(v=1/3,lty='dotted',col="yellow")
# Multitaper - przedział ufności 
Spec3 <- spec.mtm(dane_beztrendu, Ftest = TRUE,jackknife=TRUE) 
plot(P4,Ftest=TRUE,siglines=c(0.95))
abline(v=1/12,lty='dotted',col="magenta")
abline(v=1/6,lty='dotted',col="red")
abline(v=1/4,lty='dotted',col="orange")
abline(v=1/3,lty='dotted',col="yellow")
```

Legenda: linia różowa - częstotliwość 1/12; linia czerwona - częstotliwość 1/6; linia pomarańczonwa - częstotliwość 1/4; linia żółta - częstotliwość 1/3.

Periodogram wykonany metodą multitaper pokazuje ogólne występowanie dominujących częstotliwości, które można odczytać z wykresu statystyki F. Ponownie zostały wskazane częstotliwości 1/12, 1/6, 1/4 i 1/3. Wszystkie z nich są istotne statystycznie na poziomie istotności $\alpha$=0,05. Pomiędzy nimi można zaobserwować również inne mniejsze piki, na granicy istotności zupełnie bądź nieistotne.

### 4.4. Periodogram Lomb-Scargle
```{r, echo=FALSE, fig.align = 'center'}
jowisz<-dane_beztrendu
x <- seq(from=1,to=dim(jowisz)[1]) 
P5<-lsp(jowisz[,1],ofac=5,alpha=0.05)
abline(v=1/12,lty='dotted',col="magenta")
abline(v=0.167692308,lty='dotted',col="red") #przybliżone v
abline(v=0.251,lty='dotted',col="orange")
abline(v=0.335,lty='dotted',col="yellow")
```

Legenda: linia różowa - częstotliwość 1/12; linia czerwona - częstotliwość 1/6; linia pomarańczonwa - częstotliwość 1/4; linia żółta - częstotliwość 1/3; przerywana czarna linia - poziom ufności.

Periodogram LS wskazał dwa duże, istotne statystycznie piki przy częstotliwościach 1/12 i 1/6. Na periodogramie występują także mniejsze piki przy częstotliwościach 1/4 i 1/3, nieistotne statystycznie.

### 4.5. Periodogram autoregresyjny
Wykres przedstawia zmodyfikowane kryteria informacyjne: AIC (czerwony), AICc (niebieski) oraz BIC (zielony). 

```{r, echo=FALSE, fig.align = 'center'}
#model autoregresyjny dla 1-30 opóźnień 
soi.ar = ar(dane_beztrendu, order.max=30) 
#wykresy kryteriów informacyjnych
n = length(dane_beztrendu) 
AIC = rep(0, 30) -> AICc -> BIC 
for (k in 1:30){ 
  sigma2 = ar(dane_beztrendu, order=k, aic=FALSE)$var.pred 
  BIC[k] = log(sigma2) + (k*log(n)/n) 
  AICc[k] = log(sigma2) + ((n+k)/(n-k-2)) 
  AIC[k] = log(sigma2) + ((n+2*k)/n) 
} 
IC = cbind(AIC, AICc,BIC+1) 
ts.plot(IC, type="o", xlab="p", ylab="AIC /AICc/ BIC",col=c("red","blue","green")) 
abline(v=13,lty='dotted',col="grey")
```

Na podstawie osiąganych przez wszystkie kryteria minimum można określić rząd opóźnień równy 13 (szara linia). Znając tę wielkość wykreślono periodogram autoregresyjny.

```{r, echo=FALSE, fig.align = 'center'}
# minimum AIC jest osiągane dla rzędu 13 - dopasowujemy periodogram
spaic <- spec.ar(dane_beztrendu, order=13,log="no")
abline(v=1/12,lty='dotted',col="magenta")
abline(v=0.17,lty='dotted',col="red") #przybliżone v
```

Legenda: linia różowa - częstotliwość 1/12; linia czerwona - częstotliwość 1/6.

Periodogram wskazuje na obecność cykli rocznych i półrocznych.

### 4.6. Periodogram Welcha
```{r, echo=FALSE, fig.align = 'center'}
xts <- ts(dane_beztrendu, frequency=12) 
xts= xts-mean(xts) 
#periodogram Welcha 
w <- pwelch(xts, noverlap=10,plot=FALSE) 
plot(w$freq,w$spec, type='l',xlab="frequency", ylab="spectrum", main="Welch Periodogram") 
```

W przypadku analizowanych danych periodogram Welcha wskazuje na występowanie wolnych częstotliwości, co sugeruje dalsze występowanie trendu w danych. Podobnie do pozostałych, wskazuje większy obszar częstotliwości w granicach niskich częstotliwości, gdzie pozostałe periodogramy posiadają piki. Nie wskazuje natomiast żadnych szczególnych częstotliwości.

## 5. Podsumowanie
```{r, echo=FALSE, fig.align = 'center'}
zestawienie<-read.table("zestawienie.csv",header=TRUE,sep=";")
colnames(zestawienie)<-c("Cykl/Periodogram","Naiwny", "Okno Daniella", "Multitaper","Lomb-Scargle","Autoregresyjny","Welcha")
#zestawienie
kable(zestawienie)
```

Nie wszystkie metody tworzenia periodogramów wskazały te same cykle. Każdy z pozostałych periodogramów wskazał na obecność cyklu rocznego i półrocznego w analizowanym zestawie danych. Jeden z nich (multitaper) podał także informacje o istotnym istnieniu cyklu kwartalnego i czteromiesięcznego. Periodogram Welcha okazał się najgorszy ze wszystkich i nie poradził sobie z badanymi danymi.

Podsumowując, wśród analizowanych danych dotyczących stopy bezrobocia rejestrowanego w Polsce na przestrzeni ostatnich 10 lat można zauważyć regularnie występujący cykl wpływający na zmienność badanej wielkości powtarzający się co rok oraz co pół roku.

## Bibliografia

1. Dane ze strony: r-bloggers.com/2013/01/seasonal-trend-decomposition-in-r/ [Dostęp: 10.02.2021].



